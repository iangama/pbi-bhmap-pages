<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<title>BHMap Power BI</title>

<script src="https://bhmap.pbh.gov.br/v2/api/visualizador/js?funcionalidade=util&layersbase=base&versao=0.0.3"></script>

<style>
html,body{
 margin:0;
 height:100%;
 background:#111;
 font-family:Segoe UI;
}

#map{
 width:100%;
 height:100%;
}

.panel{
 position:absolute;
 top:10px;
 left:10px;
 background:rgba(0,0,0,.75);
 color:#fff;
 padding:12px;
 border-radius:8px;
}

.panel2{
 position:absolute;
 top:10px;
 right:10px;
 background:rgba(0,0,0,.75);
 color:#fff;
 padding:12px;
 border-radius:8px;
 width:320px;
 max-height:80vh;
 overflow:auto;
}
</style>
</head>

<body>

<div id="map"></div>

<div class="panel">
<b>BHMap — Diagnóstico</b><br>
✔ Script carregado<br>
✔ startMap OK<br>
✔ afterload OK
</div>

<div class="panel2">
<b>Camadas IDEBHGEO</b>
<hr>
<div id="layerList">Carregando...</div>
</div>

<script>

function init(){

 BHMap.afterload = async function(){

  try{

   const r = await fetch(
    "https://bhmap.pbh.gov.br/v2/api/metacamada/contexto/idebhgeo",
    { credentials:"include" }
   );

   if(!r.ok) throw "bloqueado";

   const txt = await r.text();
   const matches = txt.match(/ide_bhgeo:[A-Z0-9_]+/g) || [];

   buildList(matches);

  }catch(e){

   const fallback = [
"ide_bhgeo:DISTRITO_MUNICIPAL",
"ide_bhgeo:CADASTRO_IMOBILIARIO",
"ide_bhgeo:AREA_ABRANGENCIA_SAUDE",
"ide_bhgeo:ZONA_HOMOGENEA_IPTU",
"ide_bhgeo:TIPOLOGIA_USO_OCUPACAO_LOTE_2020"
   ];

   buildList(fallback);
  }

 };

 BHMap.startMap("map");
}

function buildList(list){

 const el = document.getElementById("layerList");
 el.innerHTML = "";

 list.forEach(layer=>{

  const div = document.createElement("div");

  const cb = document.createElement("input");
  cb.type="checkbox";

  cb.onchange = ()=>{

   if(cb.checked){

    BHMap.Map.addLayer(new OpenLayers.Layer.WMS(
     layer,
     "https://bhmap.pbh.gov.br/v2/api/idebhgeo/ows",
     {
      layers:layer,
      transparent:true,
      format:"image/png"
     },
     { isBaseLayer:false }
    ));

   }
  };

  div.appendChild(cb);
  div.append(layer);

  el.appendChild(div);
 });

}

init();

</script>

</body>
</html>
