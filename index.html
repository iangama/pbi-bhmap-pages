<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<title>BHMap Power BI</title>

<script src="https://bhmap.pbh.gov.br/v2/api/visualizador/js?funcionalidade=util&layersbase=base&versao=0.0.3"></script>

<style>
html,body{ margin:0; height:100%; background:#111; font-family:Segoe UI, Arial; }
#map{ position:absolute; inset:0; }

.panel{
 position:absolute; top:10px; left:10px; z-index:9999;
 background:rgba(0,0,0,.75); color:#fff;
 padding:12px; border-radius:10px; font-size:13px; max-width:360px;
 box-shadow:0 10px 30px rgba(0,0,0,.35);
}

.panel2{
 position:absolute; top:10px; right:10px; z-index:9999;
 background:rgba(0,0,0,.75); color:#fff;
 padding:12px; border-radius:10px; font-size:13px;
 width:380px; max-height:80vh; overflow:auto;
 box-shadow:0 10px 30px rgba(0,0,0,.35);
}

input[type="text"]{
 width:100%; padding:8px 10px; margin:10px 0 10px;
 border-radius:10px; border:1px solid rgba(255,255,255,.15);
 background:rgba(255,255,255,.08); color:#fff; outline:none;
}

.layerRow{
 display:flex; align-items:center; gap:8px;
 padding:6px 8px; border-radius:10px;
}
.layerRow:hover{ background:rgba(255,255,255,.08); }
.layerName{ word-break:break-word; }

.badge{ opacity:.85; font-size:12px; }

.btn{
 display:inline-block; margin-top:10px; margin-right:8px;
 padding:8px 10px; border-radius:10px;
 border:1px solid rgba(255,255,255,.2);
 background:rgba(255,255,255,.08); color:#fff; cursor:pointer;
}
.btn:hover{ background:rgba(255,255,255,.12); }
</style>
</head>

<body>
<div id="map"></div>

<div class="panel" id="diag">
<b>BHMap — Diagnóstico</b><br>
✓ Script carregado<br>
✓ startMap OK<br>
✓ afterload OK<br>
<span class="badge">Correção: toggle de visibilidade (não removeLayer), para funcionar bem no Power BI.</span>
</div>

<div class="panel2">
<b>Camadas IDEBHGEO</b><br>
<span class="badge">Marque para mostrar / desmarque para esconder (instantâneo)</span>
<input id="layerSearch" placeholder="filtrar (ex: bairro, via, escola)..." />
<div id="layerList">Carregando…</div>
<button class="btn" id="btnHideAll">Esconder todas</button>
<button class="btn" id="btnReload">Recarregar página</button>
</div>

<script>
const WMS_BASE = "https://bhmap.pbh.gov.br/v2/api/idebhgeo/ows";

/*
✅ Cole aqui a lista REAL (as ~379).
Pode manter como você já tinha: ide_bhgeo:ALGUMA_COISA
*/
const LAYERS = [
  "ide_bhgeo:CENTRO_ATENDIMENTO_TURISTA",
  "ide_bhgeo:ESTACIONAMENTO_IDOSO_PERMANENCIA_LIVRE",
  "ide_bhgeo:REDE_EST_TRANSP_COLETIVO",
  "ide_bhgeo:TIPOLOGIA_USO_OCUPACAO_LOTE_2018",
  "ide_bhgeo:TIPOLOGIA_USO_OCUPACAO_LOTE_2020",
  "ide_bhgeo:ZONA_HOMOGENEA_IPTU",
  "ide_bhgeo:AREA_ABRANGENCIA_SAUDE",
  "ide_bhgeo:DISTRITO_MUNICIPAL",
  "ide_bhgeo:CADASTRO_IMOBILIARIO"
];

// cache: layerName -> OpenLayers.Layer.WMS (cria 1x e só alterna visibilidade)
const layerCache = new Map();

// estado (para manter checkbox marcado mesmo quando filtra)
const selected = new Set();

function init(){
  BHMap.afterload = function(){
    buildLayerUI(LAYERS);
  };
  BHMap.startMap("map");
}

function ensureLayer(layerName){
  if (layerCache.has(layerName)) return layerCache.get(layerName);

  const lyr = new OpenLayers.Layer.WMS(
    layerName,
    WMS_BASE,
    { layers: layerName, transparent: true, format: "image/png" },
    { isBaseLayer: false, visibility: false }
  );

  BHMap.Map.addLayer(lyr);
  lyr.setVisibility(false);
  layerCache.set(layerName, lyr);
  return lyr;
}

function showLayer(layerName){
  const lyr = ensureLayer(layerName);
  selected.add(layerName);
  lyr.setVisibility(true);
  try { lyr.redraw(true); } catch(e) {}
}

function hideLayer(layerName){
  const lyr = ensureLayer(layerName);
  selected.delete(layerName);
  lyr.setVisibility(false);
  try { lyr.redraw(true); } catch(e) {}
}

function hideAll(){
  Array.from(selected).forEach(hideLayer);
}

function buildLayerUI(list){
  const listEl = document.getElementById("layerList");
  const searchEl = document.getElementById("layerSearch");
  const btnHideAll = document.getElementById("btnHideAll");
  const btnReload = document.getElementById("btnReload");

  function render(filter=""){
    listEl.innerHTML = "";

    const filtered = list.filter(l => l.toLowerCase().includes(filter.toLowerCase()));
    const toShow = filtered.slice(0, 120); // DOM limit PBI-safe

    const head = document.createElement("div");
    head.className = "badge";
    head.style.marginBottom = "10px";
    head.textContent = `Mostrando ${toShow.length} de ${filtered.length} (total ${list.length}). Visíveis: ${selected.size}.`;
    listEl.appendChild(head);

    toShow.forEach(layerName => {
      // garante que existe no cache (mas começa invisível)
      ensureLayer(layerName);

      const row = document.createElement("div");
      row.className = "layerRow";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = selected.has(layerName);

      cb.onchange = () => {
        if (cb.checked) showLayer(layerName);
        else hideLayer(layerName);
        head.textContent = `Mostrando ${toShow.length} de ${filtered.length} (total ${list.length}). Visíveis: ${selected.size}.`;
      };

      const name = document.createElement("div");
      name.className = "layerName";
      name.textContent = layerName + " (WMS)";

      row.appendChild(cb);
      row.appendChild(name);
      listEl.appendChild(row);
    });
  }

  render("");
  searchEl.oninput = () => render(searchEl.value);

  btnHideAll.onclick = () => {
    hideAll();
    render(searchEl.value);
  };

  btnReload.onclick = () => location.reload();
}

init();
</script>
</body>
</html>
