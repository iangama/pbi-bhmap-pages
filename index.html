<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<title>BHMap Power BI</title>

<script src="https://bhmap.pbh.gov.br/v2/api/visualizador/js?funcionalidade=util&layersbase=base&versao=0.0.3"></script>

<style>
html,body{
 margin:0;
 height:100%;
 background:#111;
 font-family:Segoe UI, Arial;
}

#map{
 width:100%;
 height:100%;
}

.panel{
 position:absolute;
 top:10px;
 left:10px;
 background:rgba(0,0,0,.75);
 color:#fff;
 padding:12px;
 border-radius:8px;
 font-size:13px;
 max-width:320px;
 z-index:999;
}

.panel2{
 position:absolute;
 top:10px;
 right:10px;
 background:rgba(0,0,0,.75);
 color:#fff;
 padding:12px;
 border-radius:8px;
 font-size:13px;
 width:320px;
 max-height:80vh;
 overflow:auto;
 z-index:999;
}

input[type=checkbox]{
 margin-right:6px;
}

input[type=text]{
 width:100%;
 padding:6px;
 margin-bottom:6px;
 border-radius:4px;
 border:none;
}

.layerRow{
 margin-bottom:4px;
}
</style>
</head>

<body>

<div id="map"></div>

<div class="panel" id="diag">
<b>BHMap — Diagnóstico</b><br/>
✓ Script carregado<br/>
✓ startMap OK<br/>
✓ afterload OK<br/>
</div>

<div class="panel2">
<b>Camadas IDEBHGEO</b>
<hr>
<input id="layerSearch" placeholder="filtrar camada..." />
<div id="layerList"></div>
</div>

<script>

const WMS_BASE = "https://bhmap.pbh.gov.br/v2/api/idebhgeo/ows";

/*
⚠ IMPORTANTE
Aqui você cola a lista REAL das layers.
Se você já tem as 373 / 379, cole aqui.
*/
const LAYERS = [
"ide_bhgeo:DISTRITO_MUNICIPAL",
"ide_bhgeo:CADASTRO_IMOBILIARIO",
"ide_bhgeo:AREA_ABRANGENCIA_SAUDE",
"ide_bhgeo:ZONA_HOMOGENEA_IPTU",
"ide_bhgeo:TIPOLOGIA_USO_OCUPACAO_LOTE"
];

function init(){

 BHMap.afterload = function(){

  buildLayerUI(LAYERS);

 };

 BHMap.startMap("map");

}

function buildLayerUI(list){

 const listEl = document.getElementById("layerList");
 const searchEl = document.getElementById("layerSearch");

 function render(filter=""){

  listEl.innerHTML="";

  list
   .filter(l=>l.toLowerCase().includes(filter.toLowerCase()))
   .slice(0,50) // limite Power BI SAFE
   .forEach(layer=>{

    const row = document.createElement("div");
    row.className="layerRow";

    const cb = document.createElement("input");
    cb.type="checkbox";

    cb.onchange = ()=>{
     if(cb.checked){
      BHMap.Map.addLayer(
       new OpenLayers.Layer.WMS(
        layer,
        WMS_BASE,
        {
         layers:layer,
         transparent:true,
         format:"image/png"
        },
        { isBaseLayer:false }
       )
      );
     }
    };

    row.appendChild(cb);
    row.append(layer);

    listEl.appendChild(row);

   });

 }

 render();

 searchEl.oninput = ()=> render(searchEl.value);

}

init();

</script>

</body>
</html>
