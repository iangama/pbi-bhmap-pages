<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BHMap + Camadas (auto + fallback)</title>
<style>
html,body{height:100%;margin:0;font-family:Arial}
#map{height:100vh;width:100vw}

.panel{
position:fixed;top:12px;left:12px;z-index:9999;
background:rgba(0,0,0,.75);color:#fff;
padding:12px 14px;border-radius:12px;max-width:680px;font-size:13px;
box-shadow:0 10px 30px rgba(0,0,0,.35)
}
.layers{
position:fixed;top:12px;right:12px;z-index:9999;
background:rgba(0,0,0,.75);color:#fff;
padding:12px 14px;border-radius:12px;
max-width:440px;max-height:72vh;overflow:auto;font-size:12px;
box-shadow:0 10px 30px rgba(0,0,0,.35)
}
.layers label{display:block;margin:6px 0;cursor:pointer}
.layers input{margin-right:6px}
.small{opacity:.85;white-space:pre-wrap}
.bad{color:#ffb3b3;white-space:pre-wrap}
.search{width:100%;padding:8px 10px;border-radius:10px;border:1px solid #ffffff33;background:#ffffff1a;color:#fff;outline:none}
.btn{
display:inline-block;margin-top:8px;margin-right:8px;
padding:8px 10px;background:#ffffff1a;border:1px solid #ffffff33;
border-radius:10px;color:#fff;text-decoration:none;cursor:pointer;font-size:12px
}
hr{border:0;border-top:1px solid #ffffff22;margin:10px 0}
code{color:#ffeaa7}
</style>
</head>
<body>

<div class="panel">
<b>BHMap ‚Äî Diagn√≥stico</b><br/>
<div id="d1">1) Carregando script‚Ä¶</div>
<div id="d2">2) startMap‚Ä¶</div>
<div id="d3">3) afterload‚Ä¶</div>
<hr/>
<b>Modo de camadas</b><br/>
<div class="small" id="modeInfo">Inicializando‚Ä¶</div>
<div class="small">
‚úÖ Primeiro tenta: <code>/metacamada/contexto/idebhgeo</code> (lista grande)<br/>
üõü Se vier bloqueado (HTML/403): cai para <code>data/layers.json</code> (cat√°logo local)
</div>
<div style="margin-top:8px">
  <a class="btn" id="btnExport" href="javascript:void(0)">Exportar cat√°logo</a>
  <a class="btn" href="javascript:location.reload()">Recarregar</a>
</div>
<div class="small" id="exportInfo"></div>
</div>

<div class="layers">
<b>Camadas</b>
<div id="layersStatus" class="small">Carregando‚Ä¶</div>
<input id="q" class="search" placeholder="filtrar (ex: bairro, escola, via)"/>
<div style="margin-top:8px" id="layersList"></div>
<div id="err" class="bad" style="display:none;"></div>
</div>

<div id="map"></div>

<script>
const CONTEXTO_URL = "https://bhmap.pbh.gov.br/v2/api/metacamada/contexto/idebhgeo";
const LOCAL_CATALOG_URL = "./data/layers.json";

// Para adicionar WMS (quando tivermos url/layerName)
const __layers = new Map();
let __defs = []; // defs normalizadas
let __mode = "boot"; // "auto" | "local"

function diag(id, ok, msg){
  document.getElementById(id).textContent = (ok ? "‚úÖ " : "‚ùå ") + msg;
}
function status(msg){ document.getElementById("layersStatus").textContent = msg; }
function mode(msg){ document.getElementById("modeInfo").textContent = msg; }
function showErr(msg){
  const el=document.getElementById("err");
  el.style.display="block";
  el.textContent=msg;
}
function clearErr(){
  const el=document.getElementById("err");
  el.style.display="none";
  el.textContent="";
}

function isBlockedHtml(txt){
  const t = (txt || "").trim().toLowerCase();
  return t.startsWith("<html") || t.includes("acesso bloqueado") || t.includes("gocache");
}

function normType(url, raw){
  const t=(raw||"").toString().toUpperCase();
  if(t.includes("WFS")) return "WFS";
  if(t.includes("WMTS")) return "WMTS";
  if(t.includes("WMS")) return "WMS";
  const u=(url||"").toString().toLowerCase();
  if(u.includes("wmts")) return "WMTS";
  if(u.includes("wfs")) return "WFS";
  return "WMS";
}

// Varredura gen√©rica em JSON procurando objetos com url + layer/name
function findDefs(obj){
  const out=[];
  const seen=new Set();
  function walk(x){
    if(!x || typeof x!=="object") return;
    if(seen.has(x)) return;
    seen.add(x);

    const url = x.url || x.URL || x.endpoint || x.serviceUrl || x.service_url || x.baseUrl || x.base_url;
    const layer = x.layer || x.layerName || x.layer_name || x.name || x.nome || x.camada || x.id;
    const title = x.title || x.titulo || x.nome || x.name || layer;
    const type = normType(url, x.type || x.tipo || x.serviceType || x.service_type);

    if(url && layer){
      out.push({ title:String(title), url:String(url), layer:String(layer), type });
    }

    for(const k of Object.keys(x)) walk(x[k]);
  }
  walk(obj);
  return out;
}

function uniq(defs){
  const set=new Set();
  const out=[];
  for(const d of defs){
    const k=d.type+"|"+d.url+"|"+d.layer;
    if(set.has(k)) continue;
    set.add(k);
    out.push(d);
  }
  return out;
}

function addWms(def){
  const k = def.type + "|" + def.url + "|" + def.layer;
  if(__layers.has(k)) return;

  // por enquanto: s√≥ WMS/WMTS (WFS fase 2)
  const layer = new OpenLayers.Layer.WMS(
    def.title,
    def.url,
    { layers: def.layer, transparent: true, format: "image/png" },
    { isBaseLayer: false, visibility: true }
  );
  BHMap.Map.addLayer(layer);
  __layers.set(k, layer);
}

function removeLayer(def){
  const k = def.type + "|" + def.url + "|" + def.layer;
  const layer = __layers.get(k);
  if(!layer) return;
  BHMap.Map.removeLayer(layer);
  __layers.delete(k);
}

function render(defs){
  clearErr();
  __defs = defs;

  const list=document.getElementById("layersList");
  list.innerHTML="";

  const q=(document.getElementById("q").value||"").toLowerCase().trim();
  const filtered = defs.filter(d => !q || (d.title+" "+d.layer).toLowerCase().includes(q));

  status(`Camadas: ${defs.length} | exibindo: ${filtered.length} (carrega ao marcar) | modo=${__mode}`);

  // limite pra n√£o travar UI
  filtered.slice(0, 220).forEach(def=>{
    if(def.type === "WFS") return; // fase 2
    const row=document.createElement("label");
    row.innerHTML = `<input type="checkbox"/> ${def.title} <span class="small">(${def.type})</span>`;
    const cb=row.querySelector("input");
    cb.addEventListener("change", ()=>{
      if(cb.checked) addWms(def);
      else removeLayer(def);
    });
    list.appendChild(row);
  });
}

async function loadLocalCatalog(){
  __mode = "local";
  mode("Usando cat√°logo local (data/layers.json).");
  status("Carregando cat√°logo local‚Ä¶");

  const r = await fetch(LOCAL_CATALOG_URL, { cache:"no-store" });
  const cat = await r.json();

  const baseUrl = cat.wms_base_url;
  const layers = Array.isArray(cat.layers) ? cat.layers : [];
  if(!baseUrl || !layers.length){
    status("Cat√°logo local vazio.");
    showErr("Preencha data/layers.json com wms_base_url e layers[].");
    return;
  }

  const defs = layers.map(l => ({
    title: String(l.title || l.name),
    type: String(l.type || "WMS").toUpperCase(),
    url: String(l.url || baseUrl),
    layer: String(l.name)
  }));

  render(uniq(defs));
}

async function loadAutoContext(){
  __mode = "auto";
  mode("Tentando auto-discovery (contexto idebhgeo)‚Ä¶");
  status("Buscando contexto idebhgeo‚Ä¶");

  const r = await fetch(CONTEXTO_URL, { cache:"no-store" });
  const txt = await r.text();

  if(isBlockedHtml(txt)){
    throw new Error("Contexto bloqueado (HTML/gocache).");
  }

  const t = txt.trim();
  const isJson = t.startsWith("{") || t.startsWith("[");
  if(!isJson){
    throw new Error("Contexto retornou XML (precisa parser dedicado).");
  }

  const defs = uniq(findDefs(JSON.parse(txt)));
  if(!defs.length){
    throw new Error("Contexto JSON ok, mas n√£o detectei defs (schema diferente).");
  }

  mode(`Auto-discovery OK: ${defs.length} defs detectadas.`);
  render(defs);
}

// Exporta o que est√° na tela para um JSON (pra voc√™ fixar e n√£o depender do endpoint)
function exportCatalog(){
  const info = document.getElementById("exportInfo");
  if(!__defs.length){
    info.textContent = "Nada para exportar (lista vazia).";
    return;
  }

  // se vier do auto, cada def j√° tem url+layer; se vier do local, tamb√©m.
  const cat = {
    wms_base_url: (__defs[0] && __defs[0].url) ? __defs[0].url : "",
    generated_at: new Date().toISOString(),
    layers: __defs.map(d => ({
      title: d.title,
      type: d.type,
      url: d.url,
      name: d.layer
    }))
  };

  const blob = new Blob([JSON.stringify(cat, null, 2)], { type:"application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "layers.export.json";
  a.click();
  URL.revokeObjectURL(a.href);

  info.textContent = `Exportado: ${__defs.length} camadas (layers.export.json).`;
}

async function bootLayers(){
  document.getElementById("q").addEventListener("input", ()=>render(__defs));
  document.getElementById("btnExport").addEventListener("click", exportCatalog);

  // tenta auto -> fallback local
  try{
    await loadAutoContext();
  } catch(e){
    mode("Auto-discovery falhou; usando cat√°logo local.");
    showErr("Auto-discovery falhou: " + String(e));
    await loadLocalCatalog();
  }
}

window.__bh_boot = function(){
  diag("d1", true, "Script BHMap carregou.");
  BHMap.afterload = function(){
    diag("d2", true, "startMap OK");
    diag("d3", true, "afterload OK");

    try{
      BHMap.Map.addControls([new OpenLayers.Control.MousePosition(), new OpenLayers.Control.ScaleLine()]);
    }catch(e){}

    bootLayers();
  };
  BHMap.startMap("map");
};
</script>

<script
src="https://bhmap.pbh.gov.br/v2/api/visualizador/js?funcionalidade=util&layersbase=base&versao=0.0.3"
onload="__bh_boot()"
onerror="diag('d1',false,'Falha ao carregar script do BHMap')">
</script>

</body>
</html>
